/**
 * Test Cases for Financial Agent
 * 
 * Run with: npx ts-node scripts/test-agent.ts
 * 
 * Make sure to set up your .env file with:
 * - SUPABASE_URL
 * - SUPABASE_SERVICE_ROLE_KEY
 * - GOOGLE_API_KEY1 (or other API keys)
 * - KV_REST_API_URL
 * - KV_REST_API_TOKEN
 */

import { config } from 'dotenv';
config();

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';

// Replace with a valid clerk_id from your database
const TEST_USER_ID = 'YOUR_CLERK_ID_HERE';

interface TestCase {
  name: string;
  message: string;
  expectedAction?: string;
  category?: string;
}

// ============================================================================
// TEST CASES
// ============================================================================

const testCases: TestCase[] = [
  // ==================== EXPENSE TESTS ====================
  {
    name: 'Add simple expense',
    message: 'Add expense of 500 for food',
    expectedAction: 'expense_added',
    category: 'Food',
  },
  {
    name: 'Add expense with note',
    message: 'I spent 150 on coffee at Starbucks',
    expectedAction: 'expense_added',
  },
  {
    name: 'Add expense with date',
    message: 'Add 2000 for groceries yesterday',
    expectedAction: 'expense_added',
  },
  {
    name: 'Add expense with payment method',
    message: 'Paid 1500 for electricity bill via UPI',
    expectedAction: 'expense_added',
    category: 'Bills',
  },
  {
    name: 'Add income',
    message: 'Add income of 50000 salary',
    expectedAction: 'expense_added',
  },
  {
    name: 'Get recent expenses',
    message: 'Show my recent expenses',
  },
  {
    name: 'Get expenses for specific category',
    message: 'How much did I spend on food this month?',
  },

  // ==================== STATS TESTS ====================
  {
    name: 'Get monthly stats',
    message: 'How much did I spend this month?',
  },
  {
    name: 'Get spending breakdown',
    message: "What's my spending by category?",
  },
  {
    name: 'Get top category',
    message: "What's my top spending category?",
  },
  {
    name: 'Get savings rate',
    message: 'What is my savings rate this month?',
  },

  // ==================== DEBT TESTS ====================
  {
    name: 'Add debt owed',
    message: 'I owe 5000 to Rahul for dinner',
    expectedAction: 'debt_added',
  },
  {
    name: 'Add debt receivable',
    message: 'Priya owes me 2000 for the movie tickets',
    expectedAction: 'debt_added',
  },
  {
    name: 'Add subscription',
    message: 'Add Netflix subscription of 499 per month',
    expectedAction: 'debt_added',
  },
  {
    name: 'Add rent',
    message: 'Add rent of 15000 due on 5th of every month',
    expectedAction: 'debt_added',
  },
  {
    name: 'Add EMI',
    message: 'Add car EMI of 12000 due on 10th',
    expectedAction: 'debt_added',
  },
  {
    name: 'Get all debts',
    message: 'Show all my debts and subscriptions',
  },
  {
    name: 'Get unpaid debts',
    message: 'What payments are pending?',
  },
  {
    name: 'Mark debt paid',
    message: 'Mark rent as paid',
    expectedAction: 'debt_paid',
  },

  // ==================== REMINDER TESTS ====================
  {
    name: 'Create reminder for tomorrow',
    message: 'Remind me about rent tomorrow',
    expectedAction: 'reminder_created',
  },
  {
    name: 'Get reminders',
    message: 'Show my upcoming reminders',
  },

  // ==================== CATEGORY TESTS ====================
  {
    name: 'Get categories',
    message: 'What categories are available?',
  },
  {
    name: 'Create custom category',
    message: 'Create a category for Pet expenses',
    expectedAction: 'category_created',
  },

  // ==================== PAYMENT METHOD TESTS ====================
  {
    name: 'Get payment methods',
    message: 'What payment methods can I use?',
  },

  // ==================== NATURAL LANGUAGE TESTS ====================
  {
    name: 'Casual expense mention',
    message: 'Had lunch for 350',
    expectedAction: 'expense_added',
  },
  {
    name: 'Multiple items mentioned',
    message: 'Spent 200 on metro and 150 on snacks',
    expectedAction: 'expense_added',
  },
  {
    name: 'Question about finances',
    message: 'Am I spending too much on food?',
  },
  {
    name: 'Comparison request',
    message: 'Compare my spending this month vs last month',
  },
];

// ============================================================================
// TEST RUNNER
// ============================================================================

async function testChat(message: string, userId: string): Promise<{ response: string; actions: string[] }> {
  const response = await fetch(`${API_URL}/api/chat`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      message,
      userId,
      stream: false, // Use non-streaming for easier testing
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(`API Error: ${error.error}`);
  }

  return response.json();
}

async function runTest(testCase: TestCase, userId: string): Promise<{ passed: boolean; details: string }> {
  console.log(`\nðŸ§ª Testing: ${testCase.name}`);
  console.log(`   Message: "${testCase.message}"`);

  try {
    const result = await testChat(testCase.message, userId);
    
    console.log(`   Response: ${result.response.substring(0, 100)}...`);
    
    if (result.actions && result.actions.length > 0) {
      console.log(`   Actions: ${result.actions.join(', ')}`);
    }

    // Check if expected action was performed
    if (testCase.expectedAction) {
      const hasExpectedAction = result.actions?.some(a => 
        a.toLowerCase().includes(testCase.expectedAction!.replace('_', ' '))
      );
      
      if (!hasExpectedAction) {
        return {
          passed: false,
          details: `Expected action "${testCase.expectedAction}" not found`,
        };
      }
    }

    return { passed: true, details: 'OK' };
  } catch (error: any) {
    return { passed: false, details: error.message };
  }
}

async function runAllTests() {
  console.log('='.repeat(60));
  console.log('ðŸš€ Financial Agent Test Suite');
  console.log('='.repeat(60));
  console.log(`\nAPI URL: ${API_URL}`);
  console.log(`User ID: ${TEST_USER_ID}`);
  
  if (TEST_USER_ID === 'YOUR_CLERK_ID_HERE') {
    console.error('\nâŒ ERROR: Please set TEST_USER_ID to a valid clerk_id from your database');
    console.log('\nTo find a valid clerk_id, run:');
    console.log('  SELECT clerk_id FROM users LIMIT 1;');
    return;
  }

  const results: { name: string; passed: boolean; details: string }[] = [];

  for (const testCase of testCases) {
    const result = await runTest(testCase, TEST_USER_ID);
    results.push({ name: testCase.name, ...result });
    
    // Add delay between requests to avoid rate limiting
    await new Promise(resolve => setTimeout(resolve, 2000));
  }

  // Summary
  console.log('\n' + '='.repeat(60));
  console.log('ðŸ“Š Test Results Summary');
  console.log('='.repeat(60));

  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;

  console.log(`\nâœ… Passed: ${passed}`);
  console.log(`âŒ Failed: ${failed}`);
  console.log(`ðŸ“ Total:  ${results.length}`);

  if (failed > 0) {
    console.log('\nâŒ Failed Tests:');
    results.filter(r => !r.passed).forEach(r => {
      console.log(`   - ${r.name}: ${r.details}`);
    });
  }
}

// Run a single test interactively
async function runSingleTest(message: string) {
  console.log('='.repeat(60));
  console.log('ðŸ§ª Single Test Mode');
  console.log('='.repeat(60));
  
  if (TEST_USER_ID === 'YOUR_CLERK_ID_HERE') {
    console.error('\nâŒ ERROR: Please set TEST_USER_ID to a valid clerk_id');
    return;
  }

  console.log(`\nMessage: "${message}"`);
  
  try {
    const result = await testChat(message, TEST_USER_ID);
    console.log('\nðŸ“¤ Response:');
    console.log(result.response);
    
    if (result.actions?.length > 0) {
      console.log('\nâœ… Actions performed:');
      result.actions.forEach(a => console.log(`   - ${a}`));
    }
  } catch (error: any) {
    console.error('\nâŒ Error:', error.message);
  }
}

// ============================================================================
// MAIN
// ============================================================================

const args = process.argv.slice(2);

if (args.length > 0) {
  // Run single test with provided message
  runSingleTest(args.join(' '));
} else {
  // Run all tests
  runAllTests();
}
